<!DOCTYPE html>
<html lang="en">
<head>
    <title>INSaFLU Visualization Frameworks</title>
    <meta charset="utf-8">
    <link href='../style/index.css' rel="stylesheet">
    <link rel="icon" href="../img/logo.png">
    <script src="https://cdn.rawgit.com/phylocanvas/phylocanvas-quickstart/v2.8.1/phylocanvas-quickstart.js"></script>

    <!-- Load d3.js and the geo projection plugin -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

    <!-- Load Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>

    <style>

        #phylocanvas {
            width: 700px;
        }

        #mapid { height: 400px; }

    </style>

</head>

<body style="min-width: 1700px; margin: auto">

<header>

    <div style="border-style: dashed; border-color: transparent; width: 100%; margin: auto;">
        <div style="border-style: dashed; border-color: transparent; float: left; margin-top: 2%; margin-left: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/ul.png" width="150">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: left;margin-top: 1.5%; margin-left: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/ist.jpg" width="130">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: right; margin-top: 1.8%; margin-right: 12.5%">
            <a href="https://imm.medicina.ulisboa.pt/pt/" target="_blank" rel="noopener noreferrer">
                <img src="../img/imm.png" width="130">
            </a>
        </div>

        <div style="border-style: dashed; border-color: transparent; float: right;margin-top: 1.5%; margin-right: 12.5%">
            <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                <img src="../img/fmul.png" width="130">
            </a>
        </div>

    </div>

    <p style="margin-top: 7%; text-align: center; font-size: 45px;"><a href="../index.html" style="color: black; text-decoration: none">Community Finding in Phylogenetic Networks</a></p>

</header>

<div style="display: block; width: 90%; float: left; margin-right: 50px; margin-left: 75px; margin-top: 50px; border-style: solid; position: relative; padding-bottom: 25px">
    <h2 style="text-align: center; font-size: 30px;">Phylogenetic Trees &#127794;</h2>

    <div style="margin-top: 25px;">

        <div style="float: left; width: 300px; height: 500px; margin-left: 5%; border-style: solid; display: block; text-align: center;">

            <h2 style="color: gray; text-align: center">Shape</h2>

            <div class="dropdown" id = "dropdown" style="margin: auto;">
                <button id = shape class="dropbtn" style="width: 90px; text-align: center; margin: auto">Shape</button>
                <div id = "dropdown-content" class="dropdown-content" style="line-height: 18px;">
                    <a id = "Radial" onclick="plot(this.id)" style="cursor: pointer;">Radial</a>
                    <a id = "Rectangular" onclick="plot(this.id)" style="cursor: pointer">Rectangular</a>
                    <a id = "Circular" onclick="plot(this.id)" style="cursor: pointer">Circular</a>
                    <a id = "Diagonal" onclick="plot(this.id)" style="cursor: pointer">Diagonal</a>
                    <a id = "Hierarchical" onclick="plot(this.id)" style="cursor: pointer">Hierarchical</a>
                </div>
            </div>

            <h2 style="color: gray; text-align: center">Metadata</h2>

            <input type="checkbox" onchange="meta();" checked><br>

        </div>

        <div style="width: 700px; height: 500px; float: left; border-style: solid; margin-left: 25px">

            <div id="phylocanvas" style="margin: auto; overflow: hidden; position: relative;"></div>

        </div>

        <div style="float: right; width: 300px; height: 500px; margin-right: 5%; border-style: solid" >

            <h2 style="color: gray; text-align: center">Newick Tree</h2>

            <form class="dropdown" action="/upload" enctype="multipart/form-data" method="post" id = "file" style="display: block; text-align: center">
                <input class = "uploads" type="file" name="upload" accept=".txt" id = "img2" style="display: none;" onchange="document.getElementById('file').submit();">
                <label for="img2"><img src="../img/up.png" style="width: 16px; cursor: pointer;" alt="Upload"></label>
            </form>

            <h2 style="color: gray; text-align: center">Metadata</h2>

            <form class="dropdown" action="/upload" enctype="multipart/form-data" method="post" id = "file" style="display: block; text-align: center">
                <input class = "uploads" type="file" name="upload" accept=".txt" id = "img2" style="display: none;" onchange="document.getElementById('file').submit();">
                <label for="img2"><img src="../img/up.png" style="width: 16px; cursor: pointer;" alt="Upload"></label>
            </form>

        </div>

    </div>

</div>

<div style="display: block; width: 90%; float: left; margin-right: 50px; margin-left: 75px; margin-top: 50px; margin-bottom: 50px; border-style: solid; padding-bottom: 25px">
    <h2 style="text-align: center; font-size: 30px;">Geographical Map &#127757;</h2>
    <div style="margin-top: 25px">

        <div style="height: 400px; margin-left: 5%; margin-right: 5%; border-style: solid" >

            <div id="mapid" style="margin: auto"></div>

        </div>

    </div>
</div>

<div class="container2" style="background-color: black; height: 50px; margin: auto">
    <p style="padding-left: 50px"><a href="https://warcraft12321.github.io/LUI/" target="_blank" rel="noopener noreferrer"><img src="../img/luiss.png" width="50px" alt="LuÃ­s"></a></p>
    <div id = "socialMedia">
        <a href = "https://www.researchgate.net/profile/Luis_Rita2" target="_blank" rel="noopener noreferrer">
            <img src = "../img/rg.png" width="25" style="margin-right: 5%" alt="ResearchGate">
        </a>
        <a href = "https://www.npmjs.com/~warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/npm.png" width="50" style="margin-right: 5%" alt="NPM">
        </a>
        <a href = "https://hub.docker.com/u/warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/docker.png" width="35" style="margin-right: 5%" alt="Docker Hub">
        </a>
        <a href = "https://github.com/warcraft12321" target="_blank" rel="noopener noreferrer">
            <img src = "../img/github.png" width="25" style="margin-right: 5%" alt="GitHub">
        </a>
    </div>
</div>

<script>

    // ------------------------------------------ Phylogenetic Trees ------------------------------------------

    function hashCode(str) { // java String#hashCode
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return hash;
    }

    function intToRGB(i){
        let c = (i & 0x00FFFFFF)
            .toString(16)
            .toUpperCase();

        return "00000".substring(0, 6 - c.length) + c;
    }

    let data;
    let metaData;

    fetch("/insaflu_tree/").then(function(res) {

        return res.text();

    }).then(function(jsonData) {

        data = jsonData;

        plot("Circular");

        // console.log(jsonData);

    });

    fetch('/insaflu_sample/').then(function(res) {

        return res.json();

    }).then(function(jsonData) {

        metaData = jsonData;

        tree.on('beforeFirstDraw', function () {

         //   console.log(Object.keys(metaData["influenza_03"]).length);

            for (let i = 0; i < tree.leaves.length; i++) {

                for (let j = 0; j < Object.keys(metaData["influenza_03"]).length; j++) {

                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]] = (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]] || {};

                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]]["colour"] = "#" + intToRGB(hashCode(Object.values(metaData[Object.keys(metaData)[i]])[j]));
                    (tree.leaves[i].data)[Object.keys(metaData[Object.keys(metaData)[i]])[j]]["label"] = Object.values(metaData[Object.keys(metaData)[i]])[j];

                }
            }
        });
    });

    let tree = Phylocanvas.createTree('phylocanvas', {

        baseNodeSize: 10,
        padding: 5,
        textSize: 10,
        font: "helvetica",
       // root: "A_H3N2_reference_demo",
        zoomFactor: 2,
        labelPadding: 5,
        showLabels: true,
        lineWidth: 3,
        alignLabels: true,
      //  highlightColour: "red",
        highlightSize: 2
     //   showBranchLengthLabels: true

    });

  //  console.log(getNodeAtMousePosition("hover"));

    /*
        tree.on('click', function (e) {
            var node = tree.getNodeAtMousePosition(e);
            if (node) {
                tree.redrawFromBranch(node);
            } else {
                tree.redrawOriginalTr();
            }
        });
    */
/*
           tree.on('beforeFirstDraw', function () {

              for (let i = 0; i < tree.leaves.length; i++) {

                //  for(let j = 0; j < metaData["influenza_03"].length; j++)

                  tree.leaves[i].data = {
                      column1: {
                          colour: '#3C7383',
                          label: 'Label' + (i + 1),
                      },
                      column2: '#9BB7BF',
                      column3: '#3C7383',
                      column4: '#9BB7BF',
                  };

              }
          });
*/
    function plot (type) {

        document.getElementById("shape").innerText = type;

        tree.load(data);

       // tree.redrawFromBranch(tree.branches["influenza_05"]);

        // Tree - Functions
          tree.setTreeType(type.toLowerCase()); // Choosing type of tree: takes radial, rectangular, circular, diagonal and hierarchy.

        if (type === "Circular" || type === "Radial") {

            for (let i = 0; i < tree.leaves.length; i++) {

                tree.leaves[i].data = {

                };
            }

        }

        tree.draw();

    }

    let active = true;

    function meta() {

        if(!active) {

                for (let i = 0; i < tree.leaves.length; i++) {
                    tree.leaves[i].data = {
                        column1: {
                            colour: '#3C7383',
                            label: 'Label' + (i + 1),
                        },
                        column2: '#9BB7BF',
                        column3: '#3C7383',
                        column4: '#9BB7BF',
                    };
                }

            active = true;

        } else {

            for (let i = 0; i < tree.leaves.length; i++) {
                tree.leaves[i].data = {

                };
            }

            active = false;

        }

        tree.draw();

    }

    let button = document.createElement("BUTTON");

    button.innerHTML = "hello";
    button.style.position = "absolute";
    button.style.right = "0";
    button.style.top = "0";
    button.id = "shape";
    button.onclick = backFunc;
    button.style.zIndex = "1";

    document.getElementById("phylocanvas").appendChild(button);

    function backFunc() {

       // tree.redrawFromBranch(tree.getSelectedNodeIds());
        console.log(tree.getSelectedNodeIds()[0]);
      //  tree.redrawFromBranch(tree.getSelectedNodeIds()[0]);
      //  tree.setRoot("influenza_12");
     //   tree.storeNode("influenza_12")
    }

  //  console.log(tree.branches["influenza_12"]);

   // tree.setRoot(tree.branches["influenza_03"]);
   //

    // ------------------------------------------ Geographical Map ------------------------------------------

    // mapid is the id of the div where the map will appear
    let map = L
        .map('mapid')
        .setView([47, 2], 5);   // center position + zoom

    // Add a tile to the map = a background. Comes from OpenStreetmap
    L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
            maxZoom: 6,
        }).addTo(map);

    // Add a svg layer to the map
    L.svg().addTo(map);

    // Create data for circles:
    let markers = [
        {long: 9.083, lat: 42.149}, // corsica
        {long: 7.26, lat: 43.71}, // nice
        {long: 2.349, lat: 48.864}, // Paris
        {long: -1.397, lat: 43.664}, // Hossegor
        {long: 3.075, lat: 50.640}, // Lille
        {long: -3.83, lat: 48}, // Morlaix
    ];

    // Select the svg area and add circles:
    d3.select("#mapid")
        .select("svg")
        .selectAll("myCircles")
        .data(markers)
        .enter()
        .append("circle")
        .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
        .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
        .attr("r", 14)
        .style("fill", "red")
     //   .attr("stroke", "red")
        .attr("stroke-width", 3)
        .attr("fill-opacity", .8);

    // Function that update circle position if something change
    function update() {
        d3.selectAll("circle")
            .attr("cx", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).x })
            .attr("cy", function(d){ return map.latLngToLayerPoint([d.lat, d.long]).y })
    }

    // If the user change the map (zoom or drag), I update circle position:
    map.on("moveend", update)

</script>

</body>

</html>