<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

      <title>Community Finding in Phylogenetic Networks</title>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.2.22/cytoscape.js"></script> <!-- Using Content Delivery Network (CDN). -->
    <script type="text/javascript" src="./louvain.js"></script>

    <style>

        #cy {
            width: 600px;
            height: 600px;
            display: block;
        }

    .node {
      stroke: white;
      stroke-width: .5px;
    }

    .link {
      stroke: #999;
      stroke-opacity: .6;
    }

    .dropbtn, #reset_btn, #comm_detect, #file{
      background-color: black;
      color: white;
      padding: 10px;
      font-size: 14px;
      border: none;
      border-radius: 10px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #ffffff;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
    }

    .dropdown-content a {
      color: black;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
    }

    .dropdown-content a:hover {background-color: black; color: white;}

    .dropdown:hover .dropdown-content {display: block;}

    .dropdown:hover .dropbtn {background-color: black;}

    footer {
        display: block;
      color:#ffffff;
      background-color: #000000;
      text-align: center;
        font-family: Helvetica;
    }

    .container2 p{
      float: left;
      border-style: dotted;
      border-color: white;
      width: 50%;
      margin-left: 25%;
        font-family: Helvetica;
    }

    #socialMedia{
      display:block;
      border-style: dashed;
      border-color: white;
      float:right;
      margin-top:0.5%;
        margin-right: 25px;
      width: 150px;
    }

    .container2 {
      width:100%;
      overflow:hidden;
      border-style: dotted;
      border-color: white;
      text-align: center;

    }

    </style>
</head>

  <body style="border-style: solid; border-color: transparent; margin: auto">

  <header style="font-family: Helvetica">

      <div style="border-style: dashed; border-color: transparent; width: 100%; margin: auto;">
          <div id="branding" style="border-style: dashed; border-color: transparent; float: left; margin-top: 3.3%; margin-left: 75px">
              <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                  <img src="./img/ul.png" width="150">
              </a>
          </div>

          <div id="branding" style="border-style: dashed; border-color: transparent; float: left;margin-top: 2.8%; margin-left: 15px">
              <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                  <img src="./img/ist.jpg" width="130">
              </a>
          </div>

          <p style="border-style: dashed; border-color: black; float: left; margin-top: 2.8%; text-align: center; font-size: 45px;">Community Finding in Phylogenetic Networks</p>

          <div id="branding" style="border-style: dashed; border-color: transparent; float: right; margin-top: 3.1%; margin-right: 75px">
              <a href="https://imm.medicina.ulisboa.pt/pt/" target="_blank" rel="noopener noreferrer">
                  <img src="./img/imm.png" width="130">
              </a>
          </div>

          <div id="branding" style="border-style: dashed; border-color: transparent; float: right;margin-top: 2.8%; margin-right: 15px">
              <a href="https://ist.pt" target="_blank" rel="noopener noreferrer">
                  <img src="./img/fmul.png" width="130">
              </a>
          </div>

      </div>

  </header>

  <div id="main" style="border-style: solid; width: 45%; float: right; margin-right: 75px">

      <h2 style="text-align: center; font-family: Helvetica; font-size: 30px">Implementation</h2>

      <div id = "cy" style="border-style: solid; display: block; margin: auto; margin-top: 25px; text-align: center">

      </div>

    <div id="content_wrapper" style=" width:100%; margin: auto; margin-top: 50px; border-style: solid">
    <input type="button" value="Reset" id='reset_btn' style="margin-left: 50px"/>
    <input type="button" value="Run" id='comm_detect'/>
      <div class="dropdown">
        <button class="dropbtn">Community Finding Algorithm</button>
        <div class="dropdown-content">
          <a href="#">Louvain</a>
          <a href="#">Infomap</a>
          <a href="#">Layered Label Propagation</a>
        </div>
      </div>
      <input type="file" id="file" name="avatar" accept="image/png, image/jpeg">
    </div>

  </div>

  <div style="float: left; border-style: solid; width: 44%; margin-left: 75px;">
      <h2 style="text-align: center; font-family: Helvetica;font-size: 30px">Abstract</h2>
      <p style="font-family: Helvetica; margin-left: 20px; margin-right: 20px; line-height: 30px; float: left">
          The aim of the thesis was to develop an improved version of PHYLOViZ Online by implementing community
          finding algorithms, as well as, adding new tools for data visualization. Similar algorithms are being used
          in other domains. In phylogenetics, it is a step forward for handling infectious diseases.
          This tool is intended to assist distinct health professionals, including doctors and bioinformaticians, and is
          designed to enable medical and research purposes.
      </p>
  </div>

  <div style="float: left; border-style: solid; width: 44%; margin-top: 20px; margin-left: 75px; height: 495px;overflow: scroll;">

      <h2 style="text-align: center; font-family: Helvetica; font-size: 30px">Algorithms</h2>

    <h2 style="text-align: left; font-family: Helvetica; color: gray; margin-left: 20px;">Infomap</h2>

    <p style="font-family: Helvetica; margin-left: 20px; line-height: 30px; margin-right: 20px;text-align: justify">
        Infomap optimizes the map equation, which exploits the information-theoretic duality between the problem of
        compressing data, and the problem of detecting and extracting significant patterns or structures within those data.
    </p>

    <h2 style="text-align: left; font-family: Helvetica; color: gray; margin-left: 20px;">Layered Label Propagation</h2>

    <p style="font-family: Helvetica; margin-left: 20px; line-height: 30px;margin-right: 20px;text-align: justify">
        Label Propagation is a semi-supervised machine learning algorithm that assigns labels to previously unlabeled
        data points. At the start of the algorithm, a (generally small) subset of the data points have labels (or
        classifications). These labels are propagated to the unlabeled points throughout the course of the algorithm.
    </p>

    <h2 style="text-align: left; font-family: Helvetica; color: gray; margin-left: 20px;">Louvain</h2>

    <p style="font-family: Helvetica; margin-left: 20px; line-height: 30px;margin-right: 20px;text-align: justify">The Louvain Method for community detection
        is a method to extract communities from large networks created
        by Blondel et al. from the University of Louvain (affiliation of authors has given the method its name). The
        method is a greedy optimization method that appears to run in time O(nlog(n)).</p>
      <mml:math xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mo>∆</mml:mo><mml:mi>M</mml:mi><mml:mo>=</mml:mo><mml:mfenced open="[" close="]" separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>W</mml:mi></mml:mrow></mml:mfrac><mml:mo>-</mml:mo><mml:msup><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mi>o</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>W</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced><mml:mo>-</mml:mo><mml:mfenced open="[" close="]" separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>W</mml:mi></mml:mrow></mml:mfrac><mml:mo>-</mml:mo><mml:msup><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mi>o</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>W</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>-</mml:mo><mml:msup><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mi>W</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math>
  </div>

  <div style="display: block; width: 90%; border-style: solid; float: left; margin-right: 50px; margin-left: 75px; margin-top: 20px; font-family: Helvetica;">
      <h2 style="text-align: center; font-family: Helvetica; font-size: 30px">Web Tools</h2>
      <div style="margin: auto;">
          <figure style="float: left; margin-left: 5%">
              <a href="https://online.phyloviz.net/index" target="_blank" rel="noopener noreferrer">
              <img src="./img/phyloviz.png" width="200px">
              </a>
          </figure>
          <div style="float: left; width: 300px; line-height: 30px">

              <h2 style="color: grey;">PHYLOViZ Online</h2>
              <p style="text-align: justify"> This is an online version of the software PHYLOViZ, a software that allows
              the analysis of sequence-based typing methods that generate allelic profiles and their associated
              epidemiological data. The main purpose was to give an user-friendly solution for data analysis and sharing
                  without installing any specific software. </p>

          </div>

          <div style="float: right; width: 300px; line-height: 30px; margin-right: 5%">

          <h2 style="color: grey;">INSaFLU</h2>
          <p style="text-align: justify"> It is a bioinformatics free web-based suite that deals with primary data
              (reads) towards the automatic generation of the output data that are actually the core first-line
              “genetic requests” for effective and timely influenza laboratory surveillance (e.g., type and sub-type
              gene and whole-genome consensus sequences, variants annotation, alignments and phylogenetic trees). Data
              integration is continuously scalable, fitting the need for a real-time epidemiological surveillance
              during the flu epidemics. </p>

      </div>

          <figure style="float: right; margin-right: 3%">
              <a href="https://insaflu.insa.pt/" target="_blank" rel="noopener noreferrer">
              <img src="./img/logo_insaflu_new.png" width="300px">
              </a>
          </figure>

      </div>
  </div>

  <div style="display: block; width: 90%; border-style: solid; float: left; margin-left: 75px; margin-top: 20px; font-family: Helvetica;">
      <h2 style="text-align: center; font-family: Helvetica; font-size: 30px">EIT Health</h2>
      <div style="margin: auto;">
          <figure style="float: left;">
              <a href="mtih.html">
              <img src="./img/mtih.jpg" width="300px">
              </a>
          </figure>
          <div style="float: left; width: 300px; line-height: 30px">

              <h2 style="color: grey;">1st Workshop MTiH (Madrid, Spain)</h2>
              <p style="text-align: justify"> As an MTiH (Master of Technological Innovation in Health) student, I was invited to present a poster
                  about my Master Thesis - Community Finding in Phylogenetic Networks using PHYLOViZ Online - and to
                  talk about my past academic achievements. During my speech, I was still able to suggest new ways of
                  improving this European program, powered by EIT Health (a body of the European Union). </p>

          </div>

          <div style="float: right; width: 300px; line-height: 30px; margin-right: 5%">

              <h2 style="color: grey;">AMR Hackathon 2018 (Heidelberg, Germany)</h2>
              <p style="text-align: justify"> I was selected to participate in a 3-day Antimicrobial Resistance Hackathon organized by EIT Health Germany. At
                  the beginning, we were divided in teams of 6/7 elements that would proceed to an AMR
                  analysis of a different EU country. </p>
          </div>

          <figure style="float: right; margin-right: 3%">
              <a href="amr.html">
              <img src="./img/amr.png" width="310px">
              </a>
          </figure>

      </div>
  </div>

    <div class="container2" style="background-color: black; height: 50px; margin: auto">
      <p style="color: white;">Luís Rita</p>
      <div id = "socialMedia">
        <a href = "" target="_blank" rel="noopener noreferrer">
          <img src = "./img/MediaIcons/facebook.png" width="25" style="margin-right: 5%">
        </a>
        <a href = "https://www.linkedin.com/in/lu%C3%ADs-rita-750302122/" target="_blank" rel="noopener noreferrer">
          <img src = "./img/MediaIcons/linkedin.png" width="25" style="margin-right: 5%">
        </a>
        <a href = "" target="_blank" rel="noopener noreferrer">
          <img src = "./img/MediaIcons/youtube.png" width="25" style="margin-right: 5%">
        </a>
        <a href = "mailto:luis20dr@gmail.com">
          <img src = "./img/MediaIcons/gmail.png" width="25" style="margin-right: 5%">
        </a>
      </div>
    </div>


  </body>

  <script>

      // Original node and edge data
      var node_data = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38,39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60 , 61, 62, 63, 64, 65 , 66, 67, 68, 69, 70, 71, 72, 73];
      var edge_data = [{"source":5,"target":0,"weight":1.2857142857142856},{"source":8,"target":5,"weight":0.125},{"source":10,"target":5,"weight":0.125},{"source":14,"target":33,"weight":0.2},{"source":16,"target":17,"weight":0.5},{"source":16,"target":57,"weight":0.2},{"source":17,"target":16,"weight":0.5},{"source":17,"target":0,"weight":0.25},{"source":20,"target":38,"weight":0.25},{"source":20,"target":36,"weight":0.8333333333333333},{"source":29,"target":17,"weight":0.5},{"source":32,"target":17,"weight":0.25},{"source":33,"target":2,"weight":0.3333333333333333},{"source":33,"target":4,"weight":0.2},{"source":34,"target":35,"weight":0.75},{"source":34,"target":58,"weight":0.16666666666666666},{"source":34,"target":9,"weight":0.5},{"source":35,"target":34,"weight":0.75},{"source":36,"target":35,"weight":0.3333333333333333},{"source":36,"target":57,"weight":0.2},{"source":38,"target":0,"weight":0.5},{"source":38,"target":20,"weight":0.25},{"source":38,"target":58,"weight":0.16666666666666666},{"source":37,"target":35,"weight":0.5833333333333333},{"source":39,"target":7,"weight":0.2},{"source":40,"target":0,"weight":0.5},{"source":41,"target":21,"weight":0.1111111111111111},{"source":41,"target":52,"weight":0.5},{"source":42,"target":22,"weight":0.5},{"source":43,"target":15,"weight":0.9663059163059161},{"source":44,"target":43,"weight":0.39285714285714285},{"source":45,"target":14,"weight":0.16666666666666666},{"source":45,"target":58,"weight":0.41666666666666663},{"source":46,"target":47,"weight":0.5095238095238095},{"source":47,"target":46,"weight":0.5095238095238095},{"source":48,"target":46,"weight":1.4773809523809522},{"source":49,"target":30,"weight":0.4583333333333333},{"source":50,"target":8,"weight":0.14285714285714285},{"source":51,"target":8,"weight":0.14285714285714285},{"source":51,"target":0,"weight":0.2},{"source":52,"target":41,"weight":0.5},{"source":53,"target":20,"weight":0.25},{"source":54,"target":20,"weight":0.25},{"source":56,"target":54,"weight":0.3333333333333333},{"source":57,"target":58,"weight":1.6666666666666665},{"source":58,"target":0,"weight":1.3666666666666665},{"source":59,"target":0,"weight":0.2},{"source":60,"target":28,"weight":0.16666666666666666},{"source":61,"target":60,"weight":0.16666666666666666},{"source":55,"target":9,"weight":1.3095238095238095},{"source":62,"target":9,"weight":0.39285714285714285},{"source":63,"target":58,"weight":0.5},{"source":64,"target":57,"weight":0.2},{"source":65,"target":64,"weight":0.3333333333333333},{"source":66,"target":15,"weight":0.25},{"source":67,"target":15,"weight":2.2},{"source":67,"target":20,"weight":0.25},{"source":68,"target":15,"weight":0.25},{"source":69,"target":22,"weight":0.6984126984126984},{"source":70,"target":9,"weight":0.14285714285714285},{"source":70,"target":22,"weight":0.3333333333333333},{"source":71,"target":14,"weight":0.3333333333333333},{"source":72,"target":71,"weight":0.3333333333333333},{"source":73,"target":3,"weight":0.2222222222222222}];

      var cy = cytoscape({

          container: document.getElementById('cy'), // container to render in

          elements: {
              nodes: [/*{
                  data: { id: "5" },
                  position: { x: 10, y: 250 }
              },
                  {
                      data: { id: "20" },
                      position: { x: 340, y: 350 }
                  },
                  {
                      data: { id: "22" },
                      position: { x: 140, y: 350 }
                  }
      */],
              edges: [{data: { id: 'ab', source: "5", target: "20" }},{data: { id: 'abb', source: "22", target: "20" }}]
          },

          style: [ // the stylesheet for the graph
              {
                  selector: 'node',
                  style: {
                      'background-color': '#666',
                     'label': 'data(id)'
                  }
              },

              {
                  selector: 'edge',
                  style: {
                      'width': 3,
                      'line-color': '#ccc',
                      'target-arrow-color': '#ccc',
                      'target-arrow-shape': 'triangle'
                  }
              }
          ],

          layout: {
              name: 'grid',
              rows: 1
          }

      });

      for (let i = 0; i < node_data.length; i++){
          cy.add({
              group: 'nodes',
              data: { id: node_data[i] },
              position: { x: 40*i, y: 300 }
          });
      }

      for(let j = 0; j < edge_data.length; j++) {
          cy.add({
              group: 'edges',
              data: {source: edge_data[j].source, target: edge_data[j].target}
          });
      }

/*
      for (let j = 0; j < edge_data.length; j++){
          cy.add({
              group: 'edges',
              data: { id: edge_data[j], source: edge_data[j].source, target: edge_data[j].target },
            //  position: { x: 40*i, y: 0 }
          });
      }
*/
  console.log('Input Node Data', node_data);
  console.log('Input Edge Data', edge_data);

  var community = jLouvain().nodes(node_data).edges(edge_data);

  // Defining drawing area dimensions.
  var width = 600;
  var height = 600;

   var original_node_data = d3.entries(node_data);
   // original_node_data:
  // index: 0
  // key: "0"
  // px: 266.08850307943777
  // py: 264.3806669411834
  // value: 0
  // weight: 7
  // x: 266.0631667717656
  // y: 264.3593913595508

  var max_weight = d3.max(edge_data, function(d){ return d.weight});
  var weight_scale = d3.scale.linear().domain([0, max_weight]).range([1,5]);

  // Force-directed graph drawing algorithms are a class of algorithms for drawing graphs in an aesthetically-pleasing
  // way. Their purpose is to position the nodes of a graph in two-dimensional or three-dimensional space so that all
  // the edges are of more or less equal length and there are as few crossing edges as possible, by assigning forces
  // among the set of edges and the set of nodes, based on their relative positions, and then using these forces either
  // to simulate the motion of the edges and nodes or to minimize their energy.
  var force = d3.layout.force()
              .charge(-30)
              .linkDistance(20)
              .size([width, height]);

  // Inserting drawing area.
  var svg = d3.select("#hello").append("svg")
    .attr("width", width)
    .attr("height", height);

  // The force layout runs asynchronously. That is, when you call force.start() it starts doing its computations that
  // determine the position of the nodes in parallel in the background. These computations are not a single step, but a
  // simulation running over a long time (several seconds).
  force.nodes(original_node_data).links(edge_data)
      .start();

  // Defining link style.
  var link = svg.selectAll(".link")
      .data(edge_data)
    .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return weight_scale(d.weight); }); // According to edge weight (from edge_data), it will be shown an edge, in the SVG, with a proportional width.

  // Defining node style.
  var node = svg.selectAll(".node")
      .data(force.nodes())
    .enter().append("circle")
      .attr("class", "node")
      .attr("r", 5)
      .style("fill", '#a30500')
      .call(force.drag);

  // The tick handler is the function that enables you to get the state of the layout when it has changed (the simulation
  // has advanced by a tick) and act on it -- in particular, redraw the nodes and links where they currently are in the simulation.
  // You don't have to handle the tick event though, you could simply run the layout for a certain number of steps and
  // then draw without handling the tick event at all, as in this example. Doing it dynamically in the tick handler
  // function has the advantage that you can see how the layout progresses. However, technically it is not needed if
  // you're just interested in the result.
  force.on("tick", function() {

      // Defining each link source and target position.
    link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

    // Defining each node position.
    node.attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; });
  });

  // Action on clicking in the Run button.
  d3.select('#comm_detect').on('click', function(){
    //Communnity detection on click event
    var community_assignment_result = community();
    var node_ids = Object.keys(community_assignment_result); // {1: 2, 2: 2, 3: 7,...}

    console.log('Resulting Community Data', community_assignment_result);

    var max_community_number = 0;
    node_ids.forEach(function(d){
      original_node_data[d].community = community_assignment_result[d]; // Assigning a community to each input node.
      max_community_number = max_community_number < community_assignment_result[d] ? community_assignment_result[d]: max_community_number;
    });

    console.log(max_community_number);

    // Defining range of colours to use when colouring each community.
    var color = d3.scale.category20().domain(d3.range([0, max_community_number]));

    // Colouring each community with a different colour.
    d3.selectAll('.node')
      .data(original_node_data)
      .style('fill', function(d){ return color(d.community);})
  });

  // Action on clicking in the Reset button. All nodes have their colours reset to a standard one.
  d3.select('#reset_btn').on('click', function(){
     d3.selectAll('.node')
      .data(original_node_data)
      .style('fill', '#a30500');
  });
  </script>
</html>
